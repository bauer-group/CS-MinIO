# =============================================================================
# MinIO - Development Mode (Local Builds)
# =============================================================================
# Usage: docker compose -f docker-compose-development.yml up -d --build
#
# Builds images locally from src/ instead of pulling from GHCR.
# Use this for developing and testing changes to the MinIO server
# image or the init container before pushing to the registry.
#
# Features:
#   - Local builds from src/minio and src/minio-init
#   - Configurable base image versions via build args
#   - Admin console with full management UI
#   - Full init container config (buckets, policies, groups, users, service accounts)
#   - IPv6 support
#
# Access:
#   - S3 API:  http://localhost:${EXPOSED_API_PORT}
#   - Console: http://localhost:${EXPOSED_CONSOLE_PORT}
# =============================================================================


### Service Templates ###
x-minio-common: &minio-common
  build:
    context: ./src/minio
    args:
      - BASE_MINIO_REPO=${BASE_MINIO_REPO:-https://github.com/karlspace/MinIO.git}
      - BASE_MINIO_VERSION=${BASE_MINIO_VERSION:-RELEASE.2025-10-15T17-29-55Z}
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "50m"
      max-file: "3"
  command: server --address ":9000" --console-address ":9001" /data
  environment:
    - TZ=${TIME_ZONE:-Etc/UTC}
    - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
    - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    - MINIO_REGION_NAME=${MINIO_REGION:-eu-central-1}
    # Disable built-in browser (admin console provides full management UI)
    - MINIO_BROWSER=off
    # ── Prometheus Monitoring (optional) ────────────────────────────
    # Metrics endpoints: /minio/v2/metrics/cluster, /minio/v2/metrics/node
    # Uncomment to allow unauthenticated scraping (default: jwt):
    # - MINIO_PROMETHEUS_AUTH_TYPE=public
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    interval: 30s
    timeout: 10s
    start_period: 30s
    retries: 4
  expose:
    - 9000/tcp
    - 9001/tcp
  networks:
    local:


services:
### Application Services ###

  # MinIO S3 Server
  minio-server:
    <<: *minio-common
    container_name: ${STACK_NAME:-s3-app}_SERVER
    hostname: minio-server
    volumes:
      - minio-data:/data
    ports:
      - "${EXPOSED_API_PORT:-9000}:9000"


### Admin Console ###

  admin-console:
    image: ghcr.io/karlspace/minio-ui/minio-admin-console:latest
    container_name: ${STACK_NAME:-s3-app}_CONSOLE
    hostname: admin-console
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MINIO_ENDPOINT=http://minio-server:9000
      - MINIO_ACCESS_KEY=${CONSOLE_USER:-console-admin}
      - MINIO_SECRET_KEY=${CONSOLE_PASSWORD}
    expose:
      - 9090/tcp
    ports:
      - "${EXPOSED_CONSOLE_PORT:-9001}:9090"
    depends_on:
      minio-server:
        condition: service_healthy
    networks:
      local:


### Initialization ###

  # MinIO Init Container (runs on every start, idempotent)
  minio-init:
    build:
      context: ./src/minio-init
      args:
        - BASE_MC_REPO=${BASE_MC_REPO:-https://github.com/karlspace/MinIO-CLI.git}
        - BASE_MC_VERSION=${BASE_MC_VERSION:-latest}
    container_name: ${STACK_NAME:-s3-app}_INIT
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "1"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MINIO_ENDPOINT=http://minio-server:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_WAIT_TIMEOUT=${MINIO_WAIT_TIMEOUT:-60}
      # Pass through environment variables used in config JSON files
      - CONSOLE_USER=${CONSOLE_USER:-console-admin}
      - CONSOLE_PASSWORD=${CONSOLE_PASSWORD:-console-admin}
      
      - APP_USER=${APP_USER:-app-service}
      - APP_PASSWORD=${APP_PASSWORD:-app-service}
      - BACKUP_USER=${BACKUP_USER:-backup-agent}
      - BACKUP_PASSWORD=${BACKUP_PASSWORD:-backup-agent}
    volumes:
      - ${MINIO_INIT_CONFIG:-./config/minio-init.example.json}:/app/config/init.json:ro
      - minio-credentials:/data/credentials
    depends_on:
      minio-server:
        condition: service_healthy
    networks:
      local:


### Volumes ###
volumes:
  minio-data:
    driver: local
    name: ${STACK_NAME:-s3-app}-data
  minio-credentials:
    driver: local
    name: ${STACK_NAME:-s3-app}-credentials


### Networks ###
networks:
  local:
    driver: bridge
    name: ${STACK_NAME:-s3-app}
    enable_ipv6: true
